#!/bin/sh
STRATIO_ENV=$1
STRATIO_MODULE="crossdata ova"
STRATIO_MODULE_VERSION="0.5.1"
ipaddress=$(ip -4 addr show dev eth0 | grep inet | sed 's/^ *//g' | cut -d' ' -f 2 | cut -d'/' -f1)

#######################################
## SERVICES
#######################################

#######################################
## Cassandra
#######################################

echo "Installing Cassandra..."
rpm --quiet -q stratio-cassandra || yum -y -q --nogpgcheck install stratio-cassandra

echo "Configuring Cassandra..."
##Config Cassandra:
sed -i "s/^\(num_tokens:\)/#\1/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^# \(initial_token:\)/\1/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(hinted_handoff_enabled:\) true$/\1 false/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(concurrent_reads:\) 32$/\1 16/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(concurrent_writes:\) 32$/\1 8/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(concurrent_counter_writes:\) 32$/\1 16/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/^\(rpc_address:\).*$/\1 0.0.0.0/" /etc/sds/cassandra/cassandra.yaml
sed -i "s/\(\-Dcassandra.logdir=\)\$CASSANDRA_HOME\/logs/\1\/var\/log\/sds\/cassandra/" /opt/sds/cassandra/bin/cassandra

#######################################
## Mongo
#######################################
rpm --quiet -q mongodb-org || yum -y -q --nogpgcheck install mongodb-org

#######################################
## Crossdata
#######################################
echo "Installing Crossdata..."
rpm --quiet -q jakarta-commons-daemon-jsvc || yum -y -q --nogpgcheck install http://prerepository.stratio.com/TEST/1.3/RHEL/6.6/x86_64/jakarta-commons-daemon-jsvc-1.0.1-8.9.el6.x86_64.rpm
rpm --quiet -q stratio-crossdata || yum -y -q --nogpgcheck install stratio-crossdata



echo "Configuring Crossdata..."
#Config Crossdata
sed -i "s/^\(CROSSDATA_HOME=\).*$/\1\"\/opt\/sds\/crossdata\"/" /etc/sds/crossdata/crossdata-env.sh
sed -i "s/^\(CROSSDATA_LOG_OUT=\).*$/\1\"\/var\/log\/sds\/crossdata\/crossdata-server.out\"/" /etc/sds/crossdata/crossdata-env.sh
sed -i "s/^\(CROSSDATA_LOG_ERR=\).*$/\1\"\/var\/log\/sds\/crossdata\/crossdata-server.err\"/" /etc/sds/crossdata/crossdata-env.sh
sed -i "s/^\(CROSSDATA_SERVER_PID=\).*$/\1\"\/var\/run\/sds\/crossdata-server.pid\"/" /etc/sds/crossdata/crossdata-env.sh


#######################################
## Connectors
#######################################
#Cassandra
echo "Installing Cassandra connector..."
rpm --quiet -q stratio-connector-cassandra || yum -y -q --nogpgcheck install stratio-connector-cassandra

#config
echo "Configuring Cassandra connector..."

#Mongo
echo "Installing Mongo connector..."
rpm --quiet -q stratio-connector-mongodb || yum -y -q --nogpgcheck install stratio-connector-mongodb

#config
echo "Configuring MongoDB connector..."


#SPARKSQL Connector
echo "Installing SparkSQL connector..."
rpm --quiet -q stratio-connector-sparksql || yum -y -q --nogpgcheck install stratio-connector-sparksql

#config
echo "Configuring SparkSQL connector..."
sed -i "s/^\(spark.home             =\).*$/\1\"\/opt\/sds\/spark\"/" /etc/sds/connectors/sparksql/connector-application.conf
sed -i 's/..\/repo\//\/opt\/sds\/connectors\/sparksql\/repo\//' /etc/sds/connectors/sparksql/connector-application.conf
sed -i 's/local\[4\]/local\[2\]/' /etc/sds/connectors/sparksql/connector-application.conf

chkconfig --add crossdata
chkconfig --add cassandra
chkconfig --add mongodb
chkconfig --add connector_cassandra
chkconfig --add connector_mongodb
chkconfig --add connector_sparksql
chkconfig crossdata off
chkconfig cassandra on
chkconfig mongodb on
chkconfig connector_cassandra off
chkconfig connector_mongodb off
chkconfig connector_sparksql off
echo "Starting services..."
service cassandra start
service mongodb start

sudo mkdir -p /user/hive/warehouse/
sudo chown -R stratio:stratio /user/hive/

cat >>/etc/rc.local <<EOF
if [ ! -f $LOCK_FILE ]; then
   curl -f -s -m 5 http://www.stratio.com/CheckUpdate/${STRATIO_MODULE}/${STRATIO_MODULE_VERSION}
   echo "ok" > ${LOCK_FILE}
fi
EOF

echo "Starting demo environment"
cat >>/home/vagrant/.bash_profile <<EOF 
echo "--- PLEASE READ /etc/sds/crossdata/README.txt ---" 
EOF
wget -P /etc/sds/crossdata https://raw.githubusercontent.com/Stratio/Crossdata/branch-0.5/sandbox/README.txt --no-check-certificate

echo "Follow instructions in /etc/sds/crossdata/README.txt"
